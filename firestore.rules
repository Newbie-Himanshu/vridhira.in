
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Core Authentication Helpers ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Special Admin: hk8913114@gmail.com / UID: my0UCiI0eCTUCVNSIHx9STUFOt62
    function isSpecialAdmin() {
      return isSignedIn() && (
        request.auth.uid == 'my0UCiI0eCTUCVNSIHx9STUFOt62' ||
        (request.auth.token.keys().contains('email') && request.auth.token.email == 'hk8913114@gmail.com')
      );
    }

    function isAdmin() {
      if (!isSignedIn()) { return false; }
      if (isSpecialAdmin()) { return true; }
      let path = /databases/$(database)/documents/customers/$(request.auth.uid);
      return exists(path) && (get(path).data.role == 'store admin' || get(path).data.role == 'owner');
    }

    function isPlatformOwner() {
      if (!isSignedIn()) { return false; }
      if (isSpecialAdmin()) { return true; }
      let path = /databases/$(database)/documents/customers/$(request.auth.uid);
      return exists(path) && get(path).data.role == 'owner';
    }

    // Global check for banned users
    function isNotBanned() {
      let path = /databases/$(database)/documents/customers/$(request.auth.uid);
      return !exists(path) || !('banUntil' in get(path).data) || get(path).data.banUntil == null || timestamp.now() > timestamp(get(path).data.banUntil);
    }

    // --- Global Admin Override ---
    // This ensures the developer always has access to manage the platform
    match /{document=**} {
      allow read, write: if isSpecialAdmin();
    }

    // --- Collection Specific Rules ---

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if (isOwner(userId) || isAdmin()) && isNotBanned();
    }

    match /customers/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if (isAdmin() || isOwner(userId)) && isNotBanned();
    }

    match /user_preferences/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if (isOwner(userId) || isAdmin()) && isNotBanned();
    }

    match /page_customizations/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /orders/{orderId} {
      // Allow users to see their own orders, and admins to see everything
      allow get: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      // For list, we need to allow if it's an admin OR if the query is properly filtered
      allow list: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if isSignedIn() && isNotBanned();
      allow update, delete: if isAdmin();
    }

    match /carts/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if (isOwner(userId) || isAdmin()) && isNotBanned();
    }

    match /platform_settings/{document} {
      allow read: if true;
      allow write: if isPlatformOwner();
    }

    match /categories/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
